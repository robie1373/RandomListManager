<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Random List Manager - Modern tool for RPG dice tables, legends, and weighted random selection">
    <meta name="theme-color" content="#0284c7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="List Manager">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%232c3e50' width='192' height='192'/><text x='50%' y='50%' font-size='80' font-weight='bold' fill='white' text-anchor='middle' dominant-baseline='central'>LM</text></svg>">
    <title>Random List Manager</title>
    <link rel="stylesheet" href="src/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="dark-mode">
    <div id="app">
        <!-- Navigation Header -->
        <header class="nav-header">
            <div class="app-title-wrapper">
                <h1 class="app-title">Random List Manager</h1>
                <span id="appVersion" class="app-version"></span>
            </div>
            <button id="toolsBtn" class="tools-btn" aria-label="Tools menu">
                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v6m0 6v6"></path><path d="M4.22 4.22l4.24 4.24m6.08 0l4.24-4.24"></path><path d="M1 12h6m6 0h6"></path><path d="M4.22 19.78l4.24-4.24m6.08 0l4.24 4.24"></path></svg>
                Tools
            </button>
        </header>
        
        <!-- Tools Menu Dropdown -->
        <div id="toolsMenu" class="tools-menu hidden">
            <div class="tools-menu-section">
                <label class="tools-menu-item">
                    <div class="switch-container">
                        <span class="switch-label">Light</span>
                        <input type="checkbox" id="darkModeToggle" checked class="switch-input">
                        <span class="switch-slider"></span>
                        <span class="switch-label">Dark</span>
                    </div>
                </label>
            </div>
            <div class="tools-menu-divider"></div>
            <div class="tools-menu-section">
                <button class="tools-menu-btn" id="exportCSV"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg> Export CSV</button>
                <button class="tools-menu-btn" id="exportJSON"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg> Export JSON</button>
                <button class="tools-menu-btn" id="exportXLSX"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg> Export XLSX</button>
                <button class="tools-menu-btn" id="exportAllTabs"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Export All Tabs (JSON)</button>
            </div>
            <div class="tools-menu-divider"></div>
            <div class="tools-menu-section">
                <button class="tools-menu-btn" id="importData"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg> Import Data</button>
                <input type="file" id="importFileInput" accept=".csv,.json,.xlsx" style="display: none;">
            </div>
            <div class="tools-menu-divider"></div>
            <div class="tools-menu-section">
                <button class="tools-menu-btn" id="deleteTab"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg> Delete Current Tab</button>
            </div>
            <div class="tools-menu-divider"></div>
            <div class="tools-menu-section">
                <button class="tools-menu-btn" id="aboutBtn"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg> About</button>
            </div>
            <div class="tools-menu-divider"></div>
            <div class="tools-menu-warning">
                <strong>⚠️ Data Storage:</strong> Your data is stored locally in your browser. It will be lost if you clear browser data or switch devices. <strong>Regularly export your data</strong> to prevent loss.
            </div>
        </div>

        <!-- About Modal -->
        <div id="aboutModal" class="modal hidden">
            <div class="modal-content">
                <button id="closeAbout" class="modal-close">✕</button>
                <h2>About Random List Manager</h2>
                <p>The Random List Manager is a versatile tool for game masters, writers, and creative professionals who need quick access to randomized content. Whether you're generating NPCs, rolling for encounters, or selecting story beats, this application provides a lightweight, browser-based solution.</p>
                
                <h3>Features</h3>
                <ul>
                    <li><strong>Multiple Tabs:</strong> Organize different random lists into separate tabs (Items, Encounters, Improvised Weapons, etc.)</li>
                    <li><strong>Weighted Rolls:</strong> Assign weight values to control the probability of each result</li>
                    <li><strong>Tag Filtering:</strong> Filter results using tags with OR/AND logic</li>
                    <li><strong>Roll History:</strong> Track all rolls made on each tab with timestamps</li>
                    <li><strong>Import/Export:</strong> Save and share your lists in CSV, JSON, or XLSX format</li>
                    <li><strong>Dark Mode:</strong> Easy on the eyes for late-night gaming sessions</li>
                </ul>
                
                <h3>How It Works</h3>
                <p>All your data is stored locally in your browser using localStorage. This means your lists persist between sessions, but they are only available on this browser and device. To ensure you don't lose your data, regularly export your lists using the "Export All Tabs" feature.</p>
                
                <h3>Tips & Tricks</h3>
                <ul>
                    <li>Use weights to make rare encounters truly rare—a weight of 1 vs 100 creates significant probability differences</li>
                    <li>Combine tags with AND logic to create nuanced filters (e.g., "magic" AND "rare" finds only magical rare items)</li>
                    <li>Export your data after major updates to maintain backups across devices</li>
                    <li>Use the roll log to track what you've already rolled and avoid repetition</li>
                </ul>
                
                <p style="margin-top: 20px; font-style: italic; color: #999;">
                    <strong>Version:</strong> <span id="aboutVersion">1.0.0</span> | Built with vanilla JavaScript | Data stays local, never shared
                </p>
            </div>
        </div>
        
        <!-- Inline prompts -->
        <div id="promptContainer" class="prompt-container hidden" role="alert">
            <div id="promptMessage" class="prompt-message"></div>
            <div class="prompt-actions">
                <button id="promptPrimary" class="prompt-btn primary"></button>
                <button id="promptSecondary" class="prompt-btn"></button>
                <button id="promptCancel" class="prompt-btn ghost">Cancel</button>
            </div>
        </div>
        
        <!-- Tab Navigation -->
        <nav class="tabs">
            <!-- Tabs dynamically rendered by JavaScript -->
        </nav>
        
        <!-- Main Content -->
        <main class="main-content">
        
        <!-- Input and Add Button -->
        <div class="input-section" style="display: none;">
            <input id="simpleInput" type="text" placeholder="Enter item name and dice (e.g., Potion 2d4)">
            <button class="btn-add">Add Item</button>
        </div>
        
        <!-- Results Display -->
        <div id="resultWrapper">
            <div id="result">Ready to roll...</div>
            <button id="copyBtn" class="hidden"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> Copy</button>
            <button id="rollBtn" class="btn-random"><svg class="icon" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="1.5"><rect x="2" y="2" width="20" height="20" rx="2" fill="none"/><circle cx="7" cy="7" r="1.5"/><circle cx="17" cy="7" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="7" cy="17" r="1.5"/><circle cx="17" cy="17" r="1.5"/></svg> Roll on Table</button>
            <div id="uniquePrompt" class="unique-prompt hidden" role="status">
                <div class="unique-prompt-text">This is marked as unique. Would you like to set the weight to zero so it cannot be rolled again?</div>
                <div class="unique-prompt-actions">
                    <button id="uniquePromptYes" class="btn-inline primary">Yes, set to zero</button>
                    <button id="uniquePromptNo" class="btn-inline">No</button>
                </div>
            </div>
        </div>
        
        <!-- Roll Log -->
        <div id="rollLogContainer" class="roll-log-container collapsed">
            <div class="roll-log-header">
                <button id="rollLogToggle" class="roll-log-toggle"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg> Show Roll Log</button>
                <button id="clearRollLog" class="roll-log-clear"><svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg> Clear</button>
            </div>
            <div id="rollLogList" class="roll-log-list"></div>
        </div>
        
        <!-- Tag Cloud -->
        <div id="tagCloudContainer">
            <div class="tag-cloud-header">
                <span class="tag-cloud-title">Filter by Tags:</span>
                <div class="tag-match-mode">
                    <label>
                        <input type="radio" name="tagMatchMode" value="OR" checked>
                        OR (any)
                    </label>
                    <label>
                        <input type="radio" name="tagMatchMode" value="AND">
                        AND (all)
                    </label>
                </div>
                <button id="clearTagsBtn" class="clear-tags-btn" title="Clear all selected tags" disabled>
                    Clear Tags
                </button>
            </div>
            <div id="tagCloud" class="tag-cloud"></div>
        </div>
        
        <!-- Tables Container -->
        <div class="tables-container">
            <!-- Items Table -->
            <div class="main-table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th class="checkbox-header"><input type="checkbox" id="selectAllCheckbox" title="Select all visible rows"></th>
                            <th id="tableNameHeader">Name</th>
                            <th>Tags</th>
                            <th>Reference</th>
                            <th>Weight</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
                <div class="table-hint">Tags autocomplete: type to see existing tags, use ↑/↓ to highlight, Tab to accept.</div>
                
                <!-- Bulk Edit Panel -->
                <div id="bulkEditPanel" class="bulk-edit-panel hidden">
                    <div class="bulk-edit-header">
                        <h3>Bulk Edit (<span id="bulkEditCount">0</span> items selected)</h3>
                    </div>
                    <div class="bulk-edit-content">
                        <div class="bulk-edit-field">
                            <label for="bulkEditTags">Add Tags (common tags shown):</label>
                            <input type="text" id="bulkEditTags" placeholder="Enter tags to add, comma-separated">
                        </div>
                        <div class="bulk-edit-field">
                            <label for="bulkEditReference">Set Reference:</label>
                            <input type="text" id="bulkEditReference" placeholder="Enter reference">
                        </div>
                        <div class="bulk-edit-actions">
                            <button id="bulkEditSave" class="btn-bulk-save">Apply</button>
                            <button id="bulkEditCancel" class="btn-bulk-cancel">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Legend Table -->
            <div class="legend-wrapper">
                <h3 class="legend-title">Legend</h3>
                <table class="legend-table">
                    <thead>
                        <tr>
                            <th>Acronym</th>
                            <th>Full Name</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="legendTableBody">
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Help Text -->
        <div class="help-text">
            <p><strong>Tag Filtering Tips:</strong></p>
            <ul>
                <li><strong>OR mode:</strong> Shows items that have ANY of the selected tags.</li>
                <li><strong>AND mode:</strong> Shows items that have ALL of the selected tags.</li>
                <li><strong>Pro tip:</strong> Use difficulty level tags (e.g., "easy", "medium", "hard") combined with AND logic to ensure roll results match your party's level. For example, select both "potion" AND "easy" to get only easy-difficulty potions.</li>
            </ul>
        </div>
        </main>
    </div>
        
    <script type="module" src="src/ui.js"></script>
    <script>
        // Initialize Lucide icons
        if (window.lucide) {
            window.lucide.createIcons();
        }

        // Register service worker in production only; auto-unregister on localhost for dev.
        if ('serviceWorker' in navigator) {
            const isLocalhost = ['localhost', '127.0.0.1', '[::1]'].includes(location.hostname);

            if (isLocalhost) {
                navigator.serviceWorker.getRegistrations()
                    .then(regs => regs.forEach(reg => reg.unregister()))
                    .catch(() => {});
            } else {
                navigator.serviceWorker.register('./sw.js')
                    .then(() => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            }
        }
    </script>
    <script type="module">
        // Fetch package.json to display current app version in the header.
        fetch('package.json')
            .then(response => response.ok ? response.json() : null)
            .then(pkg => {
                if (!pkg || !pkg.version) return;
                const versionEl = document.getElementById('appVersion');
                if (versionEl) {
                    versionEl.textContent = `v${pkg.version}`;
                }
                const aboutVersionEl = document.getElementById('aboutVersion');
                if (aboutVersionEl) {
                    aboutVersionEl.textContent = pkg.version;
                }
            })
            .catch(() => {
                // Ignore fetch errors; version display is optional.
            });
    </script>
</body>
</html>